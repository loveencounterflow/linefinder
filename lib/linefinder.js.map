{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/linefinder.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n'use strict'\n\nTU = require '../deps/traverse_util.js'\n\n#===========================================================================================================\nclass Slug\n  constructor: ({ llnr, rlnr, node, rectangle, }) ->\n    @llnr       = llnr\n    @rlnr       = rlnr\n    @node       = node\n    @rectangle  = rectangle\n    return undefined\n\n\n#===========================================================================================================\nclass @Linefinder\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    ### TAINT use intertype ###\n    defaults =\n      document:           document\n      box_element_name:   'div'\n      box_class_name:     'box'\n      xxx_height_factor:  1 / 2 ### relative minimum height to recognize line step ###\n    @cfg = Object.freeze { defaults..., cfg..., }\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  draw_box: ( rectangle ) ->\n    box               = @cfg.document.createElement @cfg.box_element_name\n    box.style.top     =  rectangle.top       + 'px'\n    box.style.left    =  rectangle.left      + 'px'\n    box.style.width   =                                             rectangle.width - 1 + 'px' # collapse borders\n    box.style.height  =                                             rectangle.height    + 'px'\n    box.classList.add @cfg.box_class_name\n    @cfg.document.body.appendChild box\n    return box\n\n  #---------------------------------------------------------------------------------------------------------\n  _get_next_chr_rectangles: ( node, c1, c2 ) ->\n    TU.TraverseUtil.getNextChar c1, c2, [], false\n    selection   = TU.TraverseUtil.setSelection c1, c2\n    range       = selection.getRangeAt 0\n    return null unless node.contains range.startContainer.parentNode\n    return null unless node.contains range.endContainer.parentNode\n    return range.getClientRects()\n\n  #---------------------------------------------------------------------------------------------------------\n  walk_chr_rectangles_of_node: ( node ) ->\n    text_node     = node.childNodes[ 0 ]\n    c1            = new TU.Cursor text_node, 0, text_node.data\n    c2            = new TU.Cursor text_node, 0, text_node.data\n    TU.TraverseUtil.setSelection c1, c2\n    loop\n      rectangles = @_get_next_chr_rectangles node, c1, c2\n      break unless rectangles?\n      for rectangle from rectangles\n        yield new DOMRect                                             \\\n          rectangle.left + @cfg.document.documentElement.scrollLeft,  \\   # left\n          rectangle.top  + @cfg.document.documentElement.scrollTop,   \\   # top\n          rectangle.width,                                            \\   # width\n          rectangle.height                                                # height\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _reset_line_walker: ( s ) ->\n    s.min_top       = +Infinity\n    s.max_bottom    = -Infinity\n    s.min_left      = +Infinity\n    s.max_right     = -Infinity\n    s.avg_height    = 0\n    s.avg_bottom    = 0\n    s.count         = 0\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  walk_line_rectangles_of_node: ( node ) ->\n    @_reset_line_walker s  = {}\n    for rectangle from @walk_chr_rectangles_of_node node\n      if s.count > 0 and rectangle.bottom - s.avg_bottom > s.avg_height * @cfg.xxx_height_factor\n        yield new DOMRect             \\\n          s.min_left,                 \\   # left\n          s.min_top,                  \\   # top\n          s.max_right   - s.min_left, \\   # width\n          s.max_bottom  - s.min_top       # height\n        @_reset_line_walker s\n      #.......................................................................................................\n      # draw_box rectangle\n      s.count++\n      s.min_top     = Math.min s.min_top,     rectangle.top\n      s.max_bottom  = Math.max s.max_bottom,  rectangle.bottom\n      s.min_left    = Math.min s.min_left,    rectangle.left\n      s.max_right   = Math.max s.max_right,   rectangle.right\n      s.avg_height  = ( s.avg_height * ( s.count - 1 ) / s.count ) + ( rectangle.height * 1 / s.count )\n      s.avg_bottom  = ( s.avg_bottom * ( s.count - 1 ) / s.count ) + ( rectangle.bottom * 1 / s.count )\n    #.........................................................................................................\n    if s.count > 0\n      yield new DOMRect             \\\n        s.min_left,                 \\   # left\n        s.min_top,                  \\   # top\n        s.max_right   - s.min_left, \\   # width\n        s.max_bottom  - s.min_top       # height\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  walk_slugs_of_node: ( node ) ->\n    rectangles  = [ ( @walk_line_rectangles_of_node node )..., ]\n    line_count  = rectangles.length\n    for rectangle, idx in rectangles\n      llnr  = idx + 1\n      rlnr  = line_count - idx\n      yield new Slug { llnr, rlnr, node, rectangle, }\n    return null\n\n"
  ]
}